// Name: Malformed user agent
//
// Description:
// Malware authors will sometimes hardcode user agent string values when writing the network communication component of their malware.
// Malformed user agents can be an indication of such malware.
//
// Severity: Medium
//
// QueryFrequency: 24
//
// QueryPeriod: 24
//
// AlertTriggerOperator: gt
//
// AlertTriggerThreshold: 0// Data Source: OfficeActivity,AzureDiagnostics
//
// Techniques: #InitialAccess, #C2, #Exfiltration
//
union isfuzzy=true
(OfficeActivity | where UserAgent != ""),
(OfficeActivity 
| where RecordType in ("AzureActiveDirectoryAccountLogon", "AzureActiveDirectoryStsLogon")
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))),
(AzureDiagnostics | where ResourceType == "APPLICATIONGATEWAYS" 
| where OperationName == "ApplicationGatewayAccess" 
| extend UserAgent = replace(@'\+', @' ', userAgent_s))
| where UserAgent startswith "UserAgent:"
